version: 2.1

commands:
  verify-install-container:
    steps:
      - run: /opt/solarwinds/uamsclient/sbin/uamsclient version
  verify-install-vm:
    steps:
      - run: ps -aux | grep "uamsclient start" | grep -v grep
  install-client:
    steps:
      - checkout
      - run: |
          cd cookbooks/uams_client_installator
          chef-client -z solo.rb
  install-chef-deb:
    steps:
      - run: apt update && apt -y install sudo curl       
      - run: curl -L https://omnitruck.chef.io/install.sh | sudo bash

  install-chef-deb-vm:
    steps:      
      - run: curl -L https://omnitruck.chef.io/install.sh | sudo bash

jobs:
  chef-lint:
    docker:
      - image: cimg/ruby:3.1.2
    steps:
      - checkout
      - run: gem install cookstyle
      - run: cookstyle cookbooks/uams_client_installator

  test-install-ubuntu-focal:
    docker:
      - image: ubuntu:focal
    steps:
      - install-chef-deb
      - install-client
      - verify-install-container

  test-install-ubuntu-focal-vm:
    machine:
      image: ubuntu-2004:current
    steps:
      - install-chef-deb-vm
      - install-client
      - verify-install-vm

workflows:
  test-uamsclient-role:
    jobs:
      - chef-lint
      - test-install-ubuntu-focal
      - test-install-ubuntu-focal-vm
